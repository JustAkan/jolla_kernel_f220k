***************
*** 1471,1481 ****
  	return ret;
  }
  
- static ssize_t aio_setup_single_vector(struct kiocb *kiocb)
  {
  	kiocb->ki_iovec = &kiocb->ki_inline_vec;
  	kiocb->ki_iovec->iov_base = kiocb->ki_buf;
- 	kiocb->ki_iovec->iov_len = kiocb->ki_left;
  	kiocb->ki_nr_segs = 1;
  	kiocb->ki_cur_seg = 0;
  	return 0;
--- 1475,1491 ----
  	return ret;
  }
  
+ static ssize_t aio_setup_single_vector(int type, struct file * file, struct kiocb *kiocb)
  {
+ 	int bytes;
+ 
+ 	bytes = rw_verify_area(type, file, &kiocb->ki_pos, kiocb->ki_left);
+ 	if (bytes < 0)
+ 		return bytes;
+ 
  	kiocb->ki_iovec = &kiocb->ki_inline_vec;
  	kiocb->ki_iovec->iov_base = kiocb->ki_buf;
+ 	kiocb->ki_iovec->iov_len = bytes;
  	kiocb->ki_nr_segs = 1;
  	kiocb->ki_cur_seg = 0;
  	return 0;
***************
*** 1500,1509 ****
  		if (unlikely(!access_ok(VERIFY_WRITE, kiocb->ki_buf,
  			kiocb->ki_left)))
  			break;
- 		ret = security_file_permission(file, MAY_READ);
- 		if (unlikely(ret))
- 			break;
- 		ret = aio_setup_single_vector(kiocb);
  		if (ret)
  			break;
  		ret = -EINVAL;
--- 1510,1516 ----
  		if (unlikely(!access_ok(VERIFY_WRITE, kiocb->ki_buf,
  			kiocb->ki_left)))
  			break;
+ 		ret = aio_setup_single_vector(READ, file, kiocb);
  		if (ret)
  			break;
  		ret = -EINVAL;
***************
*** 1518,1527 ****
  		if (unlikely(!access_ok(VERIFY_READ, kiocb->ki_buf,
  			kiocb->ki_left)))
  			break;
- 		ret = security_file_permission(file, MAY_WRITE);
- 		if (unlikely(ret))
- 			break;
- 		ret = aio_setup_single_vector(kiocb);
  		if (ret)
  			break;
  		ret = -EINVAL;
--- 1525,1531 ----
  		if (unlikely(!access_ok(VERIFY_READ, kiocb->ki_buf,
  			kiocb->ki_left)))
  			break;
+ 		ret = aio_setup_single_vector(WRITE, file, kiocb);
  		if (ret)
  			break;
  		ret = -EINVAL;
***************
*** 1532,1540 ****
  		ret = -EBADF;
  		if (unlikely(!(file->f_mode & FMODE_READ)))
  			break;
- 		ret = security_file_permission(file, MAY_READ);
- 		if (unlikely(ret))
- 			break;
  		ret = aio_setup_vectored_rw(READ, kiocb, compat);
  		if (ret)
  			break;
--- 1536,1541 ----
  		ret = -EBADF;
  		if (unlikely(!(file->f_mode & FMODE_READ)))
  			break;
  		ret = aio_setup_vectored_rw(READ, kiocb, compat);
  		if (ret)
  			break;
***************
*** 1546,1554 ****
  		ret = -EBADF;
  		if (unlikely(!(file->f_mode & FMODE_WRITE)))
  			break;
- 		ret = security_file_permission(file, MAY_WRITE);
- 		if (unlikely(ret))
- 			break;
  		ret = aio_setup_vectored_rw(WRITE, kiocb, compat);
  		if (ret)
  			break;
--- 1547,1552 ----
  		ret = -EBADF;
  		if (unlikely(!(file->f_mode & FMODE_WRITE)))
  			break;
  		ret = aio_setup_vectored_rw(WRITE, kiocb, compat);
  		if (ret)
  			break;
